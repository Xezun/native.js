<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>native.js</title>
    <script src="./Example/jquery-3.1.1.min.js"></script>
    <script src="./native/native.js"></script>

    <script>
        let date1 = Native.cookie.value("date");
        if (date1) {
            Native.log("上次访问日期：" + date1, NativeLogStyle.warning);
        }
        Native.log("Native Version: " + Native.version, NativeLogStyle.error);

        let date2 = (new Date()).toUTCString();
        Native.cookie.value("date", date2);

        $(function () {
            // 网络请求
            $("#http").click(function () {
                native.http({
                    url: "./data.json?rnd="+Math.random(),
                    method: "GET",
                    headers: {"Custom-Header": "ABCDEFG"},
                    data: {}
                }, function (response) {
                    let jq = $("#httpDiv");
                    for (let i = 0; i < response.data.length; i++) {
                        jq.append("<div>" + response.data[i] + "</div>");
                    }
                });
            });

            // 点击事件1
            $("#event1").click(function () {
                native.eventService.wasClickedOnElement("EventPage", "ProductSelectButton", {"id": 1234}, function () {
                    Native.log("打开商品规格页回调。");
                });
            });

            // 点击事件2
            $("#event2").click(function () {
                native.eventService.wasClickedOnElement("EventPage", "ProductDetailButton", {"id": 5678}, function () {
                    Native.log("进入商品详情页页回调。");
                });
            });

            // 埋点事件
            $("#event3").click(function () {
                native.eventService.track("TrackName", {"id": 123});
            });


            $("#open").click(function () {
                native.open("momshop://product?id=1234")
            });

        });


        $.holdReady(true);
        native.ready(function() {
            $.holdReady(false);
            Native.log("native is ready：" + (new Date()).toUTCString());
        });



    </script>

    <style>
        body>div {
            width: 100%;
            text-align: center;
            margin: 20px 0 0 0;
        }


    </style>
</head>
<body>

<div>native.js</div>

<div id="httpDiv">
    <div><input type="button" value="http" id="http"></div>
</div>

<div>
    <div><input type="button" value="Open" id="open"></div>
</div>

<div>
    <div><input type="button" value="打开商品规格选择页" id="event1"></div>
    <div><input type="button" value="打开商品详情页" id="event2"></div>
    <div><input type="button" value="埋点事件" id="event3"></div>
</div>

</body>
</html>









<script>

    native.core.register(function(method, parameters) {
        if (method == NativeMethod.ready) {

            Native.log("native 初始化开始：" + (new Date()).toUTCString());
            // 使用延时来模拟 App 初始化过程。
            setTimeout(function () {
                Native.log("native 初始化完成：" + (new Date()).toUTCString());
                parameters[0]({
                    currentTheme: "default",
                    currentUser: {
                        id: 123,
                        name: "John",
                        info: {},
                        version: 1
                    },
                    navigation: {
                        bar: {
                            title: "Test",
                            titleColor: "#000",
                            isHidden: false,
                            backgroundColor: "#fff"
                        }
                    },
                    networking: {
                        status: "WiFi"
                    }
                });
            }, Math.random() * 5000)

        } else if (method === NativeMethod.http) {
            let request = parameters[0];

            let headers = {
                "Api-Version": "",
                "lang": 1,
                "country": 1876,
                "currencycode": "SAR",
                "channel-id": 4,
                "device-code": "76594ffa5a77276"
            };
            if (request.headers) {
                for (let key in request.headers) {
                    if (!request.headers.hasOwnProperty(key)) {
                        continue;
                    }
                    headers[key] = request.headers[key];
                }
            }

            $.ajax({
                url: request.url,
                method: request.method,
                headers: headers,
                success: function (data) {
                    parameters[1](data);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    parameters[1]({
                        code: 1,
                        message: textStatus
                    });
                }
            })

        } else if (method === NativeMethod.open) {
            Native.log("Open page: " + parameters[0]);
        } else if (method === NativeMethod.wasClickedOnElement) {
            switch (parameters[0]) {
                case "EventPage":
                    switch (parameters[1]) {
                        case "ProductSelectButton":
                            Native.log("展示商品规格选择页：" + parameters[2].id);
                            break;

                        case "ProductDetailButton":
                            Native.log("展示商品详情页：" + parameters[2].id);
                            break;

                        default: break;
                    }

                    let callback = parameters[3];
                    if (callback) {
                        callback()
                    }
                    break;

                case "EventPage2":
                    break;
                default:
                    break;
            }
        } else if (method === NativeMethod.track) {
            Native.log("埋点：" + parameters[0] + " 参数：" + JSON.stringify(parameters[1]));
        }
    }, NativeType.javascript);

    // 模拟 App 行为
//    native.core.register(function (method, parameters, callbackID) {
//        NativeLog("执行方法 "+ method);
//        switch (method) {
//            case NativeMethodReady:
//                native.core.dispatch(callbackID, {
//                    currentTheme: "default",
//                    currentUser: {
//                        id: 123,
//                        name: "John",
//                        info: {},
//                        version: 1
//                    },
//                    navigation: {
//                        bar: {
//                            title: "Test",
//                            titleColor: "#000",
//                            isHidden: false,
//                            backgroundColor: "#fff"
//                        }
//                    },
//                    networking: {
//                        status: "WiFi"
//                    }
//                });
//                break;
//
//            case NativeMethodAlert:
//                if (confirm(JSON.stringify(parameters))) {
//                    native.core.dispatch(callbackID, 0);
//                } else {
//                    native.core.dispatch(callbackID, 1);
//                }
//                break;
//
//            case NativeMethodNumberOfRowsInList:
//                native.core.dispatch(callbackID, 10);
//                break;
//
//            case NativeMethodDataForRowAtIndex:
//                native.core.dispatch(callbackID, "Row " + parameters[2]);
//                break;
//
//            case NativeMethodCachedResourceForURL:
//                native.core.dispatch(callbackID, parameters[0]);
//                break;
//
//            default:
//                NativeLog("Method: " + method);
//                break;
//        }
//    }, NativeTypeFunction);

    // native.ready(function () {

    //    $("#alert").click(function () {
    //        native.alert({
    //            title: "This is an alert!",
    //            body: "This is alert body!",
    //            actions: ["OK", "Cancel"]
    //        }, function (index) {
    //            NativeLog("alert: " + index);
    //        });
    //    });

    //    native.dataService.numberOfRowsInList("main", "test", function (number) {
    //        for (let i = 0; i < number; i++) {
    //            native.dataService.dataForRowAtIndex("main", "test", i, function (data) {
    //                $("#dataService").append("<tr><td>" + data + "</td></tr>")
    //            })
    //        }
    //    });

    //    $("#cachedResourceForURL").click(function () {
    //        native.dataService.cachedResourceForURL("https://img0.bdstatic.com/static/searchresult/img/logo-2X_b99594a.png", "image", function (url) {
    //            $("#cachedResourceForURLImage").attr("src", url);
    //        });
    //    });

    // });
</script>